name: "Auto Assign & Unassign"

on:
    issue_comment:
        types: [created]

env:
    # Maximum number of open issues a user can have assigned in THIS repository.
    MAX_OPEN_ASSIGNMENTS: 2

# Prevent race condition when multiple users comment /assign simultaneously
concurrency:
    group: assign-issue-${{ github.event.issue.number || 'scheduled' }}
    cancel-in-progress: false

jobs:
    handle-comment:
        runs-on: ubuntu-22.04
        # Only runs on issue comments, not those of pull requests
        if: github.event.issue.pull_request == null
        timeout-minutes: 15
        permissions:
            issues: write
            pull-requests: write

        steps:
            - name: Handle /assign or /unassign
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      /**
                       * Auto-assign workflow for per-repository issue assignment limits
                       *
                       * Features:
                       * - Self-assignment only: Users comment /assign to assign themselves
                       * - Per-repo limit: Enforces MAX_OPEN_ASSIGNMENTS in this repository
                       *
                       * Configuration:
                       * - MAX_OPEN_ASSIGNMENTS: Maximum open issues per user in this repo (default: 2)
                       *
                       * Commands:
                       * - /assign: Self-assign an issue (if under limit)
                       * - /unassign: Remove self-assignment from an issue
                       *
                       * Limitations:
                       * - Small race condition window exists between checks and assignment
                       * - Only self-assignment supported (cannot assign others)
                       */

                      const comment = context.payload.comment;
                      const body = (comment.body || "").trim();
                      const user = comment.user.login;
                      const association = context.payload.comment.author_association;
                      const issue = context.payload.issue;
                      const issueNumber = issue.number;
                      const { owner, repo } = context.repo;

                      // Default assignment limit is 2 if not configured
                      const maxAssignments = parseInt(process.env.MAX_OPEN_ASSIGNMENTS || "2", 10);
                      if (!Number.isFinite(maxAssignments) || maxAssignments <= 0) {
                        throw new Error(
                          `Invalid MAX_OPEN_ASSIGNMENTS value: "${process.env.MAX_OPEN_ASSIGNMENTS}". Must be a positive integer.`
                        );
                      }

                      // Ignore bot comments
                      if (comment.user.type === "Bot") {
                        console.log("Ignoring bot comment");
                        return;
                      }

                      /**
                       * Check if a user has any merged PRs in the repository
                       * @param {object} github - GitHub API client
                       * @param {string} owner - Repository owner
                       * @param {string} repo - Repository name
                       * @param {string} username - GitHub username to check
                       * @returns {Promise<boolean>} - True if user has merged PRs, false otherwise
                       */
                      async function hasMergedPRs(github, owner, repo, username) {
                        try {
                          const query = `repo:${owner}/${repo} type:pr is:merged author:${username}`;
                          const result = await github.rest.search.issuesAndPullRequests({
                            q: query,
                            per_page: 1,
                          });
                          const count = result.data.total_count;
                          console.log(`User ${username} has ${count} merged PR(s) in ${owner}/${repo}`);
                          return count > 0;
                        } catch (error) {
                          console.error(`Error checking merged PRs for ${username}:`, error);
                          // On error, return false to be safe (deny access)
                          return false;
                        }
                      }

                      const isAssign = body.startsWith("/assign");
                      const isUnassign = body.startsWith("/unassign");

                      if (!isAssign && !isUnassign) {
                        console.log("Not an /assign or /unassign command");
                        return;
                      }

                      if (isAssign && body.trim() !== "/assign") {
                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number: issueNumber,
                          body: `❌ @${user} This workflow only supports self-assignment. Use \`/assign\` without specifying a username.`,
                        });
                        return;
                      }

                      /**
                       * NOTE
                       *
                       * List of possible user association values:
                       * https://docs.github.com/en/graphql/reference/enums#commentauthorassociation
                       *
                       * COLLABORATOR: Author has been invited to collaborate on the repository.
                       * CONTRIBUTOR: Author has previously committed to the repository.
                       * FIRST_TIMER: Author has not previously committed to GitHub.
                       * FIRST_TIME_CONTRIBUTOR: Author has not previously committed to the repository.
                       * MANNEQUIN: Author is a placeholder for an unclaimed user.
                       * MEMBER: Author is a member of the organization that owns the repository.
                       * NONE: Author has no association with the repository.
                       * OWNER: Author is the owner of the repository.
                       */

                      if (isAssign) {
                        const currentAssignees = (issue.assignees || []).map((a) => a.login);

                        // Already assigned
                        if (currentAssignees.includes(user)) {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body: `⚠️ @${user} You are already assigned to this issue.`,
                          });
                          console.log(`${user} is already assigned, skipping.`);
                          return;
                        }

                        if (currentAssignees.length > 0) {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body: `⚠️ @${user} This issue is already assigned, possibly because a prerequisite or parent issue is incomplete. Please choose a different issue.`,
                          });
                          console.log("Issue already assigned to someone else, skipping.");
                          return;
                        }

                        // Evaluate the permissions to do assignments
                        const issueCreator = issue.user.login;
                        let issueCreatorAssociation;

                        // Fetch author_association via REST API (source of truth)
                        try {
                          const issueDetails = await github.rest.issues.get({
                            owner,
                            repo,
                            issue_number: issueNumber,
                          });
                          issueCreatorAssociation = issueDetails.data.author_association;
                        } catch (error) {
                          console.error(`Error fetching issue details for #${issueNumber}:`, error);
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body: `❌ Failed to verify issue permissions. Please contact a maintainer or try again later.`,
                          });
                          return;
                        }

                        console.log(
                          `Issue #${issueNumber} creator ${issueCreator} has association: ${issueCreatorAssociation}`
                        );

                        // Allow /assign on issues created by OWNER, MEMBER, or COLLABORATOR
                        const allowedAssociations = ["OWNER", "MEMBER", "COLLABORATOR"];

                        console.log(`DEBUG - issueCreatorAssociation = ${issueCreatorAssociation}`);

                        if (!allowedAssociations.includes(issueCreatorAssociation)) {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body:
                              `❌ @${user} The \`/assign\` feature is only available for issues created by ` +
                              `OWNER, MEMBER, or COLLABORATOR user associations. This issue was created by ` +
                              `@${issueCreator} who has the association: ${issueCreatorAssociation}.`,
                          });
                          console.log(
                            `Denied /assign for ${user} - Issue creator ${issueCreator} has insufficient association (${issueCreatorAssociation})`
                          );
                          return;
                        }
                        console.log(
                          `Issue creator ${issueCreator} has sufficient association (${issueCreatorAssociation}), allowing /assign for ${user}`
                        );
                      }

                      console.log(`Commenting user ${user} is a ${association}`);

                      // New contributors cannot auto assign themselves (unless they have a merged PR),
                      // but they can unassign themselves.
                      if (isAssign) {
                        if (
                          association === "FIRST_TIME_CONTRIBUTOR" ||
                          association === "FIRST_TIMER" ||
                          association === "NONE"
                        ) {
                          const hasContributed = await hasMergedPRs(github, owner, repo, user);

                          if (!hasContributed) {
                            await github.rest.issues.createComment({
                              owner,
                              repo,
                              issue_number: issueNumber,
                              body:
                                `❌ @${user} First time contributors cannot use auto assignment. ` +
                                `You have not successfully merged code into this repository. ` +
                                `Please ask to be assigned instead.`,
                            });
                            return;
                          }
                        }
                      }

                      if (isUnassign) {
                        if (body.trim() !== "/unassign") {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body: `❌ @${user} This workflow only supports \`/unassign\` without additional text.`,
                          });
                          console.log("Invalid /unassign command (must be exact)");
                          return;
                        }

                        const currentAssignees = (issue.assignees || []).map((a) => a.login);

                        if (!currentAssignees.includes(user)) {
                          console.log(`${user} is not assigned, skipping unassign`);
                          return;
                        }

                        try {
                          await github.rest.issues.removeAssignees({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            assignees: [user],
                          });

                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body: `✅ Unassigned @${user} successfully.`,
                          });

                          console.log(`Unassigned ${user} from #${issueNumber}`);
                        } catch (error) {
                          console.error(`Error unassigning user ${user} from issue #${issueNumber}:`, error);

                          try {
                            await github.rest.issues.createComment({
                              owner,
                              repo,
                              issue_number: issueNumber,
                              body:
                                `❌ Failed to unassign @${user}. Please try again or contact a maintainer.`,
                            });
                          } catch (commentError) {
                            console.error(
                              `Failed to create error comment for user ${user} on issue #${issueNumber}:`,
                              commentError
                            );
                          }
                        }
                        return;
                      }

                      console.log(`Checking repo-wide assignments for ${user} in ${owner}/${repo}...`);

                      let totalAssigned = 0;
                      try {
                        const assignedIssues = await github.paginate(
                          github.rest.issues.listForRepo,
                          {
                            owner,
                            repo,
                            state: "open",
                            assignee: user,
                            per_page: 100,
                          }
                        );
                        totalAssigned = assignedIssues.length;
                      } catch (error) {
                        console.error("Error fetching repo-wide assignments:", error);

                        try {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body:
                              `❌ **Assignment check failed**\n\n` +
                              `Could not verify how many issues @${user} currently has assigned in this repository.\n\n` +
                              `**Error:** ${error.message || "Unknown error"}\n\n` +
                              `Please contact a maintainer or try again later.`,
                          });
                        } catch (commentError) {
                          console.error(
                            `Failed to post error comment for user ${user} on issue #${issueNumber}:`,
                            commentError
                          );
                        }

                        throw new Error(
                          `Assignment failed for ${user} on issue #${issueNumber}: ${error.message || error}`
                        );
                      }

                      console.log(
                        `${user} currently has ${totalAssigned} open issues assigned in ${owner}/${repo}`
                      );

                      // NOTE: There is still a small race window between this check and the actual
                      // assignment where another workflow run could assign this user elsewhere.
                      // For simplicity we accept that small chance here.
                      if (totalAssigned >= maxAssignments) {
                        const message =
                          `⚠️ @${user} already has ${totalAssigned} open assignments in this repository. ` +
                          `Please finish or unassign before taking new ones.`;
                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number: issueNumber,
                          body: message,
                        });
                        console.log("Limit reached, skipping assignment");
                        return;
                      }

                      try {
                        await github.rest.issues.addAssignees({
                          owner,
                          repo,
                          issue_number: issueNumber,
                          assignees: [user],
                        });

                        await github.rest.issues.createComment({
                          owner,
                          repo,
                          issue_number: issueNumber,
                          body: `✅ Assigned @${user} successfully.`,
                        });

                        console.log(`Assigned ${user} to #${issueNumber}`);
                      } catch (error) {
                        console.error(`Error assigning user ${user} to issue #${issueNumber}:`, error);

                        try {
                          await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number: issueNumber,
                            body:
                              `❌ **Assignment failed**\n\n` +
                              `Could not assign @${user} to this issue.\n\n` +
                              `**Error:** ${error.message || "Unknown error"}\n\n` +
                              `Please try again or contact a maintainer.`,
                          });
                        } catch (commentError) {
                          console.error(
                            `Failed to post error comment for user ${user} on issue #${issueNumber}:`,
                            commentError
                          );
                          throw new Error(
                            `Assignment failed and unable to notify user: ${error.message || error}`
                          );
                        }
                      }
