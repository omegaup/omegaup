name: Check PR Linked Issue & Assignee

on:
  pull_request_target:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read
jobs:
  check-issue-link:
    runs-on: ubuntu-22.04
    steps:
      - name: Check Linked Issue and Assignee
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    closingIssuesReferences(first: 10) {
                      nodes {
                        number
                        assignees(first: 10) {
                          nodes {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: context.repo.owner,
              // Note: context.repo.repo is the repository name (not a typo); this is the correct way to access it in GitHub Actions.
              repo: context.repo.repo,
              prNumber: context.issue.number
            };

            const result = await github.graphql(query, variables);
            const linkedIssues = result.repository.pullRequest.closingIssuesReferences.nodes;
            const prAuthor = context.payload.pull_request.user.login.toLowerCase();

            console.log(`PR Author: ${prAuthor}`);

            if (linkedIssues.length === 0) {
              const prBody = context.payload.pull_request.body || "";
              const issueMatches = prBody.match(/#\d+/g) || [];
              const mentionedIssueNumbers = issueMatches.map(x => Number(x.replace("#", "")));

              if (mentionedIssueNumbers.length === 0) {
                core.setFailed("❌ PR is not linked to any issue. Please add 'Fixes #issue_number' to the PR description.");
                return;
              }

              let isAssigned = false;

              for (const issueNumber of mentionedIssueNumbers) {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                const assignees = issue.data.assignees.map(node => node.login.toLowerCase());
                console.log(`Issue #${issueNumber} assignees: ${JSON.stringify(assignees)}`);

                if (assignees.includes(prAuthor)) {
                  isAssigned = true;
                  break;
                }
              }

              if (!isAssigned) {
                core.setFailed(`❌ Linked issue(s) ${mentionedIssueNumbers.map(n => "#" + n).join(", ")} are not assigned to you (@${prAuthor}). Please assign the issue to yourself before submitting.`);
                return;
              } else {
                console.log("✅ PR is correctly linked to an issue assigned to the author.");
                return;
              }
            }

            let isAssigned = false;
            let linkedIssueNumbers = [];

            for (const issue of linkedIssues) {
              linkedIssueNumbers.push("#" + issue.number);
              const assignees = issue.assignees.nodes.map(node => node.login.toLowerCase());
              console.log(`Issue #${issue.number} assignees: ${JSON.stringify(assignees)}`);
              
              if (assignees.includes(prAuthor)) {
                isAssigned = true;
                break;
              }
            }

            if (!isAssigned) {
              core.setFailed(`❌ Linked issue(s) ${linkedIssueNumbers.join(", ")} are not assigned to you (@${prAuthor}). Please assign the issue to yourself before submitting.`);
            } else {
              console.log("✅ PR is correctly linked to an issue assigned to the author.");
            }
