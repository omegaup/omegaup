name: Discord Issue Thread Notification

on:
  issues:
    types: [labeled, opened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Label Conditions
        id: check-label
        run: |
          ALLOWED_LABELS=("GSoC" "Good first issue")
          CURRENT_LABEL="${{ github.event.label.name }}"
          
          # For 'opened' events, check all labels
          if [ "${{ github.event.action }}" == "opened" ]; then
            ISSUE_LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
            for label in "${ALLOWED_LABELS[@]}"; do
              if echo "$ISSUE_LABELS" | grep -q "\"$label\""; then
                echo "should_notify=true" >> $GITHUB_OUTPUT
                echo "matched_label=$label" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
          fi
          
          # For 'labeled' events, check the specific label
          if [ "${{ github.event.action }}" == "labeled" ]; then
            for label in "${ALLOWED_LABELS[@]}"; do
              if [ "$CURRENT_LABEL" == "$label" ]; then
                echo "should_notify=true" >> $GITHUB_OUTPUT
                echo "matched_label=$label" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
          fi
          
          echo "should_notify=false" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: steps.check-label.outputs.should_notify == 'true'
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          script: |
            const https = require('https');
            const url = require('url');
            
            const issue = context.payload.issue;
            const label = '${{ steps.check-label.outputs.matched_label }}';
            
            // Truncate description
            let description = issue.body || 'No description provided';
            if (description.length > 200) {
              description = description.substring(0, 200) + '...';
            }
            
            // Create thread name (max 100 chars)
            let threadName = `Issue #${issue.number}: ${issue.title}`;
            if (threadName.length > 100) {
              threadName = threadName.substring(0, 97) + '...';
            }
            
            const payload = {
              thread_name: threadName,
              embeds: [{
                title: `ğŸ†• Issue #${issue.number}: ${issue.title}`,
                url: issue.html_url,
                color: 0x58ACFF,
                fields: [
                  {
                    name: 'ğŸ“ Description',
                    value: description,
                    inline: false
                  },
                  {
                    name: 'ğŸ·ï¸ Label',
                    value: label,
                    inline: true
                  },
                  {
                    name: 'ğŸ‘¤ Author',
                    value: issue.user.login,
                    inline: true
                  }
                ],
                footer: {
                  text: 'omegaUp Issues'
                },
                timestamp: new Date().toISOString()
              }]
            };
            
            const webhookUrl = new URL(process.env.DISCORD_WEBHOOK_URL + '?wait=true');
            
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            return new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('âœ… Discord notification sent successfully');
                    console.log('Response:', data);
                    resolve(data);
                  } else {
                    console.log('âŒ Discord API error:', res.statusCode, data);
                    reject(new Error(`Discord API returned ${res.statusCode}`));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(JSON.stringify(payload));
              req.end();
            });