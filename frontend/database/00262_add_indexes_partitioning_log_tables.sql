-- Step 1: Problemset_Access_Log
-- Drop foreign keys (required for partitioning)
ALTER TABLE `Problemset_Access_Log`
  DROP FOREIGN KEY `fk_palc_problemset_id`,
  DROP FOREIGN KEY `fk_pali_identity_id`;

-- Drop old single-column indexes and add composite index
ALTER TABLE `Problemset_Access_Log`
  DROP INDEX `problemset_id`,
  DROP INDEX `identity_id`,
  ADD INDEX `idx_pal_problemset_identity_time` (`problemset_id`, `identity_id`, `time`);

-- Add partitioning by time
ALTER TABLE `Problemset_Access_Log`
  PARTITION BY RANGE (UNIX_TIMESTAMP(`time`)) (
    PARTITION p_history VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01 00:00:00')),
    PARTITION p_2025_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01 00:00:00')),
    PARTITION p_2025_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2025-07-01 00:00:00')),
    PARTITION p_2025_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2025-10-01 00:00:00')),
    PARTITION p_2025_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2026-01-01 00:00:00')),
    PARTITION p_2026_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2026-04-01 00:00:00')),
    PARTITION p_2026_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2026-07-01 00:00:00')),
    PARTITION p_2026_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2026-10-01 00:00:00')),
    PARTITION p_2026_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2027-01-01 00:00:00')),
    PARTITION p_2027_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2027-04-01 00:00:00')),
    PARTITION p_2027_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2027-07-01 00:00:00')),
    PARTITION p_2027_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2027-10-01 00:00:00')),
    PARTITION p_2027_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2028-01-01 00:00:00')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
  );

-- Step 2: Identity_Login_Log
-- Drop foreign key (required for partitioning)
ALTER TABLE `Identity_Login_Log`
  DROP FOREIGN KEY `fk_illi_identity_id`;

-- Note: keeping `identity_id` index because idx_loginlog_time_identity(time, identity_id)
-- has identity_id as the second column and cannot serve WHERE identity_id = ? queries.

-- Add partitioning by time
ALTER TABLE `Identity_Login_Log`
  PARTITION BY RANGE (UNIX_TIMESTAMP(`time`)) (
    PARTITION p_history VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01 00:00:00')),
    PARTITION p_2025_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2025-04-01 00:00:00')),
    PARTITION p_2025_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2025-07-01 00:00:00')),
    PARTITION p_2025_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2025-10-01 00:00:00')),
    PARTITION p_2025_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2026-01-01 00:00:00')),
    PARTITION p_2026_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2026-04-01 00:00:00')),
    PARTITION p_2026_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2026-07-01 00:00:00')),
    PARTITION p_2026_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2026-10-01 00:00:00')),
    PARTITION p_2026_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2027-01-01 00:00:00')),
    PARTITION p_2027_q1 VALUES LESS THAN (UNIX_TIMESTAMP('2027-04-01 00:00:00')),
    PARTITION p_2027_q2 VALUES LESS THAN (UNIX_TIMESTAMP('2027-07-01 00:00:00')),
    PARTITION p_2027_q3 VALUES LESS THAN (UNIX_TIMESTAMP('2027-10-01 00:00:00')),
    PARTITION p_2027_q4 VALUES LESS THAN (UNIX_TIMESTAMP('2028-01-01 00:00:00')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
  );
