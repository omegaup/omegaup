<template>
  <div class="d-flex align-items-center flex-wrap px-4">
    <hr class="w-100 my-2" />
    <div class="w-100 d-flex justify-content-between">
      <div class="notification-date">
        {{ date }}
      </div>
      <button
        class="close"
        @click.prevent="$emit('remove', notification, null)"
      >
        ‚ùå
      </button>
    </div>
    <div
      class="w-100 d-flex align-items-center pt-1"
      :class="{ 'notification-link': url }"
      @click="handleClick"
    >
      <img class="d-block" width="50" :src="iconUrl" />
      <div class="d-flex flex-column ms-2 flex-grow-1">
        <template v-if="notificationMarkdown">
          <omegaup-markdown :markdown="notificationMarkdown"></omegaup-markdown>
        </template>
        <div v-else-if="url">
          <a :href="url">
            {{ text }}
          </a>
        </div>
        <div v-else>
          {{ text }}
        </div>
        <button
          v-if="notification.contents.type === 'badge'"
          class="btn btn-outline-primary btn-sm mt-2 align-self-start"
          @click.stop="showShareModal = true"
        >
          {{ T.shareYourBadge }}
        </button>
      </div>
    </div>
    <!-- Share badges modal -->
    <omegaup-share-badges
      v-if="notification.contents.type === 'badge'"
      ref="shareBadges"
      v-model="showShareModal"
      :badge-name="notification.contents.badge"
      @copy-badge-image="handleCopyBadgeImage"
    ></omegaup-share-badges>
  </div>
</template>

<script lang="ts">
import { Vue, Component, Prop } from 'vue-property-decorator';
import { types } from '../../api_types';
import T from '../../lang';
import * as ui from '../../ui';
import * as time from '../../time';

import omegaup_Markdown from '../Markdown.vue';
import omegaup_ShareBadges from './ShareBadges.vue';

@Component({
  components: {
    'omegaup-markdown': omegaup_Markdown,
    'omegaup-share-badges': omegaup_ShareBadges,
  },
})
export default class Notification extends Vue {
  @Prop() notification!: types.Notification;
  T = T;
  showShareModal = false;

  get iconUrl(): string {
    if (this.notification.contents.body) {
      return this.notification.contents.body.iconUrl;
    }

    switch (this.notification.contents.type) {
      case 'badge':
        return `/media/dist/badges/${this.notification.contents.badge}.svg`;
      case 'demotion':
        if (this.notification.contents.status == 'banned') {
          return '/media/banned.svg';
        }
        return '/media/warning.svg';
      case 'general_notification':
        return '/media/email.svg';
      default:
        return '/media/info.png';
    }
  }

  get text(): string {
    switch (this.notification.contents.type) {
      case 'demotion':
        return this.notification.contents.message || '';
      case 'general_notification':
        return this.notification.contents.message || '';
      default:
        return '';
    }
  }

  get notificationMarkdown(): string {
    if (this.notification.contents.body) {
      return ui.formatString(
        T[this.notification.contents.body.localizationString],
        this.notification.contents.body.localizationParams,
      );
    }
    switch (this.notification.contents.type) {
      case 'badge':
        return ui.formatString(T.notificationNewBadge, {
          badgeName: T[`badge_${this.notification.contents.badge}_name`],
        });
      default:
        return '';
    }
  }

  get url(): string {
    if (this.notification.contents.body) {
      return this.notification.contents.body.url;
    }

    switch (this.notification.contents.type) {
      case 'general_notification':
        return this.notification.contents.url || '';
      case 'badge':
        return `/badge/${this.notification.contents.badge}/`;
      case 'demotion':
        // TODO: Add link to problem page.
        return '';
      default:
        return '';
    }
  }

  get date() {
    return time.formatDateLocalHHMM(this.notification.timestamp);
  }

  handleClick(): void {
    if (this.url) {
      this.$emit('remove', this.notification, this.url);
    }
  }

  async handleCopyBadgeImage(badgeName: string): Promise<void> {
    try {
      const badgeImageUrl = `/media/dist/badges/${badgeName}.svg`;
      const canvas = document.createElement('canvas');
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.src = badgeImageUrl;

      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = reject;
      });

      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        throw new Error('Could not get canvas context');
      }

      ctx.drawImage(img, 0, 0);

      const blob = await new Promise<Blob | null>((resolve) => {
        canvas.toBlob(resolve);
      });

      if (!blob) {
        throw new Error('Could not create blob from canvas');
      }

      const clipboardData: Record<string, Blob> = {
        [blob.type]: blob,
      };

      if ('ClipboardItem' in window) {
        const ClipboardItemConstructor = (window as any).ClipboardItem as {
          new (data: Record<string, Blob>): any;
        };
        await navigator.clipboard.write([
          new ClipboardItemConstructor(clipboardData),
        ]);
        (this.$refs.shareBadges as any).showTooltip(
          T.badgeImageCopiedToClipboard,
        );
      }
    } catch (error) {
      (this.$refs.shareBadges as any).showTooltip(
        T.badgeImageManualCopyInstructions,
      );
    }
  }
}
</script>

<style lang="scss" scoped>
@import '../../../../sass/main.scss';
.close {
  font-size: inherit;
}

.notification-date {
  font-size: 0.8rem;
  color: var(--notifications-notification-date-font-color);
}

.notification-link {
  cursor: pointer;

  &:hover {
    background-color: rgba(
      var(--notifications-notification-link-background-color--hover),
      0.05
    );
  }
}
</style>
